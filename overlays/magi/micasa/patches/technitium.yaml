apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: technitium-dns
spec:
  volumeClaimTemplates:
    - metadata:
        name: config
      spec:
        accessModes:
        - ReadWriteOnce
        storageClassName: rook-ceph-block
        resources:
          requests:
            storage: 1Gi
        
  template:
    metadata:
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [{
            "name": "home-net",
            "namespace": "default",
            "interface": "net1",
            "ips": ["172.16.15.204/24","fd7a:6e5b:beff:15::204/64"]
          }]
    spec:
      initContainers:
      - name: route-init
        image: wbitt/network-multitool:latest
        securityContext:
          privileged: true
        command:
        - /bin/sh
        - -c
        - |
          set -eux
          # IPv4 routes (idempotent)
          ip -4 route replace 172.16.15.0/24 dev net1 table 100
          ip -4 route replace default via 172.16.15.1 dev net1 table 100

          # IPv4 rule (add only if missing)
          ip -4 rule show | grep -q "from 172.16.15.204 .* lookup 100" || ip -4 rule add from 172.16.15.204 lookup 100

          # IPv6 routes (idempotent)
          ip -6 route replace fd7a:6e5b:beff:15::/64 dev net1 table 100
          ip -6 route replace default via fd7a:6e5b:beff:15::1 dev net1 table 100

          # IPv6 rule (add only if missing)
          ip -6 rule show | grep -q "from fd7a:6e5b:beff:15::204 .* lookup 100" || ip -6 rule add from fd7a:6e5b:beff:15::204 lookup 100